{% load humanize %}
<div class="container-fluid">
  <form action="" id="checkout-form">
    <div class="form-group mb-3">
      <label for="payable_amount" class="control-label">Payable Amount</label>
      <input
        type="text"
        id="payable_amount"
        class="form-control form-control-lg rounded-0 text-end"
        value="{{ grand_total|intcomma }}"
        required
        disabled
      >
    </div>

    <div class="form-group mb-3 row">
      <label class="control-label">Payment Method</label>
      <div class="col-4">
        <input type="radio" name="payment_method" id="cash_method" value="cash" checked>
        <label for="cash_method" class="control-label">Cash</label>
      </div>
      <div class="col-4">
        <input type="radio" name="payment_method" id="mpesa_method" value="mpesa">
        <label for="mpesa_method" class="control-label">Mpesa</label>
      </div>
      <div class="col-4">
        <input type="radio" name="payment_method" id="both_method" value="both">
        <label for="both_method" class="control-label">Both</label>
      </div>

      <div class="col-12">
        <div class="form-group mb-3" id="cash_amount_field" hidden>
          <label for="cash_amount" class="control-label">Cash Amount</label>
          <input
            type="number"
            step="any"
            id="cash_amount"
            name="cash_amount"
            class="form-control form-control-lg rounded-0 text-end"
            value="0"
          >
        </div>

        <div class="form-group mb-3" id="mpesa_code_field" hidden>
          <label for="mpesa_code" class="control-label">Mpesa Transaction Code</label>
          <input
            type="text"
            id="mpesa_code"
            name="mpesa_code"
            class="form-control form-control-lg rounded-0 text-end"
          >
        </div>

        <div class="form-group mb-3" id="mpesa_amount_field" hidden>
          <label for="mpesa_amount" class="control-label">Mpesa Amount</label>
          <input
            type="number"
            step="any"
            id="mpesa_amount"
            name="mpesa_amount"
            class="form-control form-control-lg rounded-0 text-end"
            value="0"
          >
        </div>
      </div>
    </div>

    <div class="form-group mb-3" hidden>
      <label for="tendered_amount" class="control-label">Tendered Amount</label>
      <input
        type="number"
        step="any"
        id="tendered_amount"
        name="tendered_amount"
        class="form-control form-control-lg rounded-0 text-end"
        value="0"
        required
        disabled
      >
    </div>

    <div class="form-group mb-3">
      <label for="payment_change" class="control-label">Change</label>
      <input
        type="text"
        id="payment_change"
        class="form-control form-control-lg rounded-0 text-end"
        value="{{ 0|intcomma }}"
        required
        disabled
      >
    </div>

    <!-- Hidden field for amount change -->
    <input type="hidden" name="amount_change" value="0">
  </form>
</div>

<script>
  $(function() {
    // parse grand total once
    const grandTotal = parseFloat($('#payable_amount').val().replace(/,/g, '')) || 0;
    $('#tendered_amount').val(grandTotal).prop('hidden', true);

    // UTILITY to sync pos-form hidden fields
    function syncPosField(name, val) {
      $('#pos-form input[name="' + name + '"]').val(val);
    }

    // Main handler for when customer picks cash/mpesa/both
    $('#checkout-form input[name="payment_method"]').on('change', function() {
      const method = this.value;

      // SHOW/HIDE fields
      $('#cash_amount_field').prop('hidden', method !== 'both');
      $('#mpesa_code_field').prop('hidden', method === 'cash');
      $('#mpesa_amount_field').prop('hidden', method !== 'both');

      $('#mpesa_code').prop('required', method !== 'cash');
      $('#cash_amount').prop('required', method === 'both');
      $('#mpesa_amount').prop('required', method === 'both');

      // Reset values/UI
      $('#payment_change').val('0');
      $('[name="amount_change"]').val('0');

      if (method === 'mpesa') {
        $('#tendered_amount').val(grandTotal);
      } else if (method === 'both') {
        $('#cash_amount').val('');
        $('#mpesa_amount').val(grandTotal);
        $('#tendered_amount').val(grandTotal);
      } else {
        // cash
        $('#cash_amount').val('');
        $('#mpesa_amount').val('0');
        $('#mpesa_code').val('');
        $('#tendered_amount').val(grandTotal);
      }

      // 1) Check the correct radio in checkout-form
      $('#checkout-form input[name="payment_method"][value="' + method + '"]')
        .prop('checked', true);

      // 2) Sync hidden pos-form payment_method
      syncPosField('payment_method', method);
      syncPosField('tendered_amount', $('#tendered_amount').val());
      syncPosField('amount_change', 0);
      syncPosField('cash_amount', $('#cash_amount').val() || 0);
      syncPosField('mpesa_code', $('#mpesa_code').val());
      syncPosField('mpesa_amount', $('#mpesa_amount').val() || 0);
    });

    // Uppercase MPESA codes
    $('#checkout-form [name="mpesa_code"]').on('keyup', function() {
      $(this).val(this.value.toUpperCase());
      syncPosField('mpesa_code', this.value);
    });

    // When cash amount changes in “both” mode
    $('#checkout-form [name="cash_amount"]').on('input', function() {
      const cashAmt = parseFloat(this.value) || 0;
      const mpesaAmt = grandTotal - cashAmt;
      $('#mpesa_amount').val(mpesaAmt.toFixed(2));

      // always tender full total
      $('#tendered_amount').val(grandTotal);
      $('#payment_change').val('0');

      // Sync hidden fields
      syncPosField('cash_amount', cashAmt);
      syncPosField('mpesa_amount', mpesaAmt);
      syncPosField('tendered_amount', grandTotal);
      syncPosField('amount_change', 0);
    });

    // If user manually edits tendered_amount (forces cash)
    $('#tendered_amount').on('input', function() {
      const tendered = parseFloat(this.value.replace(/,/g,'')) || 0;
      const change = tendered - grandTotal;

      $('#payment_change').val(change.toLocaleString('en-US'));
      $('[name="amount_change"]').val(change);

      // force cash selection
      $('#checkout-form input[name="payment_method"][value="cash"]')
        .prop('checked', true)
        .trigger('change');
    });

    // FINAL submit
    $('#checkout-form').on('submit', function(e) {
      e.preventDefault();
      const changeVal = parseFloat($('[name="amount_change"]').val()) || 0;
      if (changeVal < 0) {
        return alert("Tendered Amount is lower than Payable Amount");
      }
      $('#pos-form').submit();
    });
  });
</script>
