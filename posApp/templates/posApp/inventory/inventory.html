{% extends "posApp/base.html" %}
{% load humanize %}
{% block pageContent %}
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Inventory</h4>
            <!--ul class="nav flex-row">
                <li class="nav-item">
                    <a class="nav-link active" href="{% url 'inventory' %}">
                        Inventory
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" href="{% url 'stocks-page' %}">
                        Stock
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'product-page' %}">
                        Products
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'category-page' %}">
                        Categories
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="{% url 'supplier-page' %}">
                        Suppliers
                    </a>
                </li>
            </ul-->
        </div>
    </div>
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-6">
    <div class="mdc-card py-2">
        <div class="mt-4">
            <h5>Expiring Soon Stocks</h5>
            <canvas id="expiringSoonChart"></canvas>
            <div id="expiringSoonLegend" class="mt-3"></div> <!-- Legend container -->
        </div>
    </div>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-6">
    <div class="mdc-card py-2">
        <div class="mt-4">
            <h5>Low Stock Levels</h5>
            <canvas id="lowStockChart"></canvas>
            <div id="lowStockLegend" class="mt-3"></div> <!-- Legend container -->
        </div>
    </div>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-6">
    <div class="mdc-card py-2">
        <div class="mt-4">
            <h5>Top-Selling Products</h5>
            <canvas id="topSellingChart"></canvas>
            <div id="topSellingLegend" class="mt-3"></div> <!-- Legend container -->
        </div>
    </div>
</div>
<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-6">
    <div class="mdc-card py-2">
        <div class="mt-4">
            <h5>Stock Value by Category</h5>
            <canvas id="stockValueChart"></canvas>
            <div id="stockValueLegend" class="mt-3"></div> <!-- Legend container -->
        </div>
    </div>
</div>

{% endblock pageContent%}

{% block ScriptBlock %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Helper function to generate custom legends
    function generateLegend(containerId, labels, data, colors) {
        const legendContainer = document.getElementById(containerId);
        legendContainer.innerHTML = ''; // Clear any existing legends
        labels.forEach((label, index) => {
            const legendItem = `
                <div class="d-flex align-items-center mb-2">
                    <div style="width: 20px; height: 20px; background-color: ${colors[index % colors.length]}; margin-right: 10px;"></div>
                    <span>${label}: ${data[index]}</span>
                </div>
            `;
            legendContainer.innerHTML += legendItem;
        });
    }

    // Fetch data for Expiring Soon Stocks
    fetch("{% url 'inventory_data' %}?type=expiring_soon")
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('expiringSoonChart').getContext('2d');
            const expiringSoonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.products,
                    datasets: [{
                        label: 'Expiring Soon (Quantity)',
                        data: data.quantities,
                        backgroundColor: '#FF6666', // Light Red
                        borderColor: '#CC3333', // Dark Red
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }, // Disable default legend
                        title: { display: true, text: 'Expiring Soon Stocks' }
                    }
                }
            });

            // Generate custom legends
            let new_data = data.quantities.map((value, index) => {
                return {
                    label: data.products[index],
                    value: `${value} units`, // Prepend 'units' for quantities
                };
            });

            generateLegend(
                'expiringSoonLegend',
                new_data.map(item => item.label), // Extract labels
                new_data.map(item => item.value), // Use the formatted value
                ['#FF6666']
            );
        });

    // Fetch data for Low Stocks
    fetch("{% url 'inventory_data' %}?type=low_stock")
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('lowStockChart').getContext('2d');
            const lowStockChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.products,
                    datasets: [{
                        label: 'Low Stock (Quantity)',
                        data: data.quantities,
                        backgroundColor: '#66FF66', // Light Green
                        borderColor: '#33CC33', // Dark Green
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }, // Disable default legend
                        title: { display: true, text: 'Low Stock Levels' }
                    }
                }
            });

            // Generate custom legends
            let new_data = data.quantities.map((value, index) => {
                return {
                    label: data.products[index],
                    value: `${value} units`, // Prepend 'units' for quantities
                };
            });

            generateLegend(
                'lowStockLegend',
                new_data.map(item => item.label), // Extract labels
                new_data.map(item => item.value), // Use the formatted value
                ['#66FF66']
            );
        });

    // Fetch data for Top-Selling Products
    fetch("{% url 'inventory_data' %}?type=top_selling")
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('topSellingChart').getContext('2d');
            const topSellingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.products,
                    datasets: [{
                        label: 'Units Sold',
                        data: data.quantities,
                        backgroundColor: '#66FFFF', // Light Cyan
                        borderColor: '#33CCCC', // Dark Cyan
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }, // Disable default legend
                        title: { display: true, text: 'Top-Selling Medicine' }
                    }
                }
            });

            // Generate custom legends
            let new_data = data.quantities.map((value, index) => {
                return {
                    label: data.products[index],
                    value: `${value} units`, // Prepend 'units' for quantities
                };
            });

            generateLegend(
                'topSellingLegend',
                new_data.map(item => item.label), // Extract labels
                new_data.map(item => item.value), // Use the formatted value
                ['#66FFFF']
            );
        });

    // Fetch data for Stock Value by Category
    fetch("{% url 'inventory_data' %}?type=stock_value")
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('stockValueChart').getContext('2d');
            const stockValueChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.categories,
                    datasets: [{
                        label: 'Stock Value',
                        data: data.values,
                        backgroundColor: [
                            '#FF6666', '#FFCC66', '#FFFF66', '#66FF66', '#66FFFF',
                            '#6699FF', '#CC66FF', '#FF99CC', '#CCCCCC', '#FF9966'
                        ],
                        borderColor: [
                            '#CC3333', '#CC9933', '#CCCC33', '#33CC33', '#33CCCC',
                            '#3366CC', '#9933CC', '#CC6699', '#999999', '#CC6633'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }, // Disable default legend
                        title: { display: true, text: 'Stock Value by Category' }
                    }
                }
            });

            let new_data = data.values.map((value, index) => {
                return {
                    label: data.categories[index],
                    value: `Ksh. ${value.toLocaleString()}`, // Prepend 'Ksh.' to the value
                };
            });

            // Generate custom legends
            generateLegend(
                'stockValueLegend',
                new_data.map(item => item.label), // Extract labels
                new_data.map(item => item.value), // Use the formatted value
                [
                    '#FF6666', '#FFCC66', '#FFFF66', '#66FF66', '#66FFFF',
                    '#6699FF', '#CC66FF', '#FF99CC', '#CCCCCC', '#FF9966'
                ]
            );
        });
</script>
{% endblock ScriptBlock %}