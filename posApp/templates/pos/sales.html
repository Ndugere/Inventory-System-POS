{% extends "base.html" %}
{% load humanize %}
{% block pageContent %}

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card py-2">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Sales List</h4>
            <div>
                <label for="payment-filter">Filter by Payment Method:</label>
                <select id="payment-filter" class="form-select form-select-sm">
                    <option value="" {% if not selected_method %}selected{% endif %}>All</option>
                    {% for method, label in payment_methods %}
                        <option value="{{ method }}" {% if selected_method == method %}selected{% endif %}>{{ label }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>
</div>

<div class="mdc-layout-grid__cell stretch-card mdc-layout-grid__cell--span-12">
    <div class="mdc-card">
        {% include "pos/tables/sales_table.html" %}
    </div>
</div>

{% endblock pageContent %}

{% block ScriptBlock %}
<script>
    function fetchSalesPage(url) {
        start_loader();
        $.ajax({
            url: url,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(data) {
                $('#sales-table-wrapper').html(data.html);
                end_loader();
            },
            error: function(err) {
                console.error(err);
                alert_toast("Failed to load sales data.", 'error');
                end_loader();
            }
        });
    }

    // View and delete handlers
    $(document).on('click', '.view-data', function() {
        uni_modal("Transaction's Receipt", "{% url 'receipt-modal' %}?id=" + $(this).data('id'))
    });

    $(document).on('click', '.delete-data', function() {
        const id = $(this).data('id');
        const code = $(this).data('code');
        _conf("Are you sure to delete <b>" + code + "</b> Transaction record?", "delete_sale", [id])
    });

    function delete_sale($id) {
        start_loader();
        $.ajax({
            headers: {
                "X-CSRFToken": '{{csrf_token}}'
            },
            url: "{% url 'delete-sale' %}",
            method: "POST",
            data: {
                id: $id
            },
            dataType: "json",
            error: err => {
                console.log(err)
                alert_toast("An error occured.", 'error');
                end_loader();
            },
            success: function(resp) {
                if (typeof resp == 'object' && resp.status == 'success') {
                    location.reload();
                } else {
                    alert_toast("An error occured.", 'error');
                    end_loader();
                }
            }
        });
    }

    // AJAX filter + pagination
    $(function() {
        $('#payment-filter').change(function() {
            const method = $(this).val();
            const url = new URL(window.location.href);
            url.searchParams.set('payment_method', method);
            url.searchParams.set('page', 1); // Reset page
            fetchSalesPage(url.toString());
        });

        $(document).on('click', '.pagination a', function(e) {
            e.preventDefault();
            const url = $(this).attr('href');
            if (url) fetchSalesPage(url);
        });
    });
</script>
{% endblock ScriptBlock %}
